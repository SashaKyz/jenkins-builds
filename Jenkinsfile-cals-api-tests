



pipeline {
    agent none

    tools {
        gradle 'Gradle_3.5.1'
    }
    options {
        buildDiscarder(logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '', numToKeepStr: '5'))
        timestamps()
    }
    parameters {
        string(defaultValue: 'development', description: '', name: 'branch')
        string(defaultValue: 'https://cals-api.preint.cwds.io/', description: '', name: 'APP_URL')
        [$class: 'NodeParameterDefinition', allowedSlaves: ['ALL (no restriction)'], defaultSlaves: ['preint'], description: '', name: 'nnode', nodeEligibility: [$class: 'AllNodeEligibility'], triggerIfResult: 'multiSelectionDisallowed']
    }
    triggers {
        pollSCM('H/15 * * * 1-5')
    }

    stages {
      stage('Preparation'){
        agent { node { label '$nname' } }
        steps{
           cleanWs()
           git branch: '$branch', credentialsId: '433ac100-b3c2-4519-b4d6-207c029a103b', url: 'git@github.com:ca-cwds/cals-api.git'
        }
      }
      stage('Run tests'){
        agent { node { label '$nname' } }
        steps{
           script{
              def serverArti = Artifactory.newServer url: 'http://pr.dev.cwds.io/artifactory'
              def rtGradle = Artifactory.newGradleBuild()
		      rtGradle.resolver server: serverArti
		      rtGradle.useWrapper = true
		      writeFile file: "gradle.properties", text: "cals.api.url=${APP_URL}"
		      def buildInfo = rtGradle.run buildFile: 'build.gradle', tasks: 'integrationTest'
           }
        }
      }
      stage('Reports') {
        steps{
            script{
                publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'build/reports/tests/integrationTest', reportFiles: 'index.html', reportName: 'Integration Test Report', reportTitles: ''])
            }
        }
      }
    }


}
